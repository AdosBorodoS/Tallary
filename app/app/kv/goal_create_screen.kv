#:import dp kivy.metrics.dp

<GoalCreateScreen>:
    name: "goal_create"

    BoxLayout:
        orientation: "vertical"
        padding: dp(12)
        spacing: dp(10)
        canvas.before:
            Color:
                rgba: 0.06, 0.06, 0.06, 1
            Rectangle:
                pos: self.pos
                size: self.size

        # ---------------- TOP BAR ----------------
        BoxLayout:
            size_hint_y: None
            height: dp(56)
            spacing: dp(8)

            Button:
                size_hint_x: None
                width: dp(44)
                text: "‚Üê"
                background_normal: ""
                background_color: 0.12, 0.12, 0.12, 1
                color: 1, 1, 1, 1
                on_release: root.on_back_button_click()

            Label:
                text: "–ù–æ–≤–∞—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Ü–µ–ª—å"
                bold: True
                halign: "left"
                valign: "middle"
                text_size: self.size
                color: 1, 1, 1, 1

            Widget:

            Button:
                size_hint_x: None
                width: dp(44)
                text: "üë§"
                background_normal: ""
                background_color: 0.12, 0.12, 0.12, 1
                color: 1, 1, 1, 1
                on_release: print("[GoalCreateScreen] profile icon click")

        # ---------------- CONTENT ----------------
        ScrollView:
            do_scroll_x: False
            size_hint_y: 1
            scroll_y: 1
            on_size: self.scroll_y = 1

            BoxLayout:
                orientation: "vertical"
                size_hint_y: None
                height: self.minimum_height
                spacing: dp(12)

                # -------- TITLE CARD --------
                BoxLayout:
                    orientation: "vertical"
                    padding: dp(14)
                    spacing: dp(10)
                    size_hint_y: None
                    height: self.minimum_height
                    canvas.before:
                        Color:
                            rgba: 0.10, 0.10, 0.10, 1
                        RoundedRectangle:
                            pos: self.pos
                            size: self.size
                            radius: [dp(12),]

                    Label:
                        text: "–ù–∞–∑–≤–∞–Ω–∏–µ —Ü–µ–ª–∏"
                        size_hint_y: None
                        height: dp(20)
                        color: 0.85, 0.85, 0.85, 1
                        halign: "left"
                        valign: "middle"
                        text_size: self.size

                    TextInput:
                        id: goalNameInput
                        hint_text: "–ù–∞–ø—Ä–∏–º–µ—Ä, –ö—É–ø–∏—Ç—å –¥–æ–º"
                        text: root.goalNameText
                        on_text: root.goalNameText = self.text
                        multiline: False
                        size_hint_y: None
                        height: dp(44)
                        padding: [dp(12), dp(10)]
                        background_normal: ""
                        background_active: ""
                        background_color: 0.15, 0.15, 0.15, 1
                        foreground_color: 1, 1, 1, 1
                        hint_text_color: 0.6, 0.6, 0.6, 1
                        cursor_color: 1, 1, 1, 1

                # -------- CONDITIONS CARD --------
                BoxLayout:
                    orientation: "vertical"
                    padding: dp(14)
                    spacing: dp(10)
                    size_hint_y: None
                    height: self.minimum_height
                    canvas.before:
                        Color:
                            rgba: 0.10, 0.10, 0.10, 1
                        RoundedRectangle:
                            pos: self.pos
                            size: self.size
                            radius: [dp(12),]

                    Label:
                        text: "–£—Å–ª–æ–≤–∏—è"
                        bold: True
                        size_hint_y: None
                        height: dp(22)
                        color: 1, 1, 1, 1
                        halign: "left"
                        valign: "middle"
                        text_size: self.size

                    RecycleView:
                        viewclass: "GoalConditionRow"
                        data: root.conditionsData
                        size_hint_y: None
                        height: conditionsLayout.minimum_height
                        do_scroll_y: False

                        RecycleBoxLayout:
                            id: conditionsLayout
                            orientation: "vertical"
                            spacing: dp(10)
                            default_size: None, dp(92)
                            default_size_hint: 1, None
                            size_hint_y: None
                            height: self.minimum_height

                    Button:
                        text: "+  –î–æ–±–∞–≤–∏—Ç—å —É—Å–ª–æ–≤–∏–µ"
                        size_hint_y: None
                        height: dp(44)
                        background_normal: ""
                        background_color: 0.12, 0.12, 0.12, 1
                        color: 1, 1, 1, 1
                        bold: True
                        on_release: root.on_add_condition_button_click()

                # -------- PARTICIPANTS CARD --------
                BoxLayout:
                    orientation: "vertical"
                    padding: dp(14)
                    spacing: dp(10)
                    size_hint_y: None
                    height: self.minimum_height
                    canvas.before:
                        Color:
                            rgba: 0.10, 0.10, 0.10, 1
                        RoundedRectangle:
                            pos: self.pos
                            size: self.size
                            radius: [dp(12),]

                    Label:
                        text: "–£—á–∞—Å—Ç–Ω–∏–∫–∏ —Ü–µ–ª–∏"
                        bold: True
                        size_hint_y: None
                        height: dp(22)
                        color: 1, 1, 1, 1
                        halign: "left"
                        valign: "middle"
                        text_size: self.size

                    Button:
                        text: "üë•  –î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞ –∫ —Ü–µ–ª–∏"
                        size_hint_y: None
                        height: dp(44)
                        background_normal: ""
                        background_color: 0.27, 0.62, 0.97, 1
                        color: 1, 1, 1, 1
                        bold: True
                        on_release:
                            if "friendSearchPopup" in root.ids:
                                root.ids.friendSearchPopup.open()
                            else:
                                print("[GoalCreateScreen] ERROR: friendSearchPopup id not found")

                    RecycleView:
                        viewclass: "GoalParticipantRow"
                        data: root.participantsData
                        size_hint_y: None
                        height: participantsLayout.minimum_height
                        do_scroll_y: False

                        RecycleBoxLayout:
                            id: participantsLayout
                            orientation: "vertical"
                            spacing: dp(10)
                            default_size: None, dp(44)
                            default_size_hint: 1, None
                            size_hint_y: None
                            height: self.minimum_height

                Widget:
                    size_hint_y: None
                    height: dp(8)

                Label:
                    text: root.statusText
                    size_hint_y: None
                    height: dp(20) if root.statusText else 0
                    opacity: 1 if root.statusText else 0
                    color: 0.70, 0.70, 0.70, 1
                    halign: "left"
                    valign: "middle"
                    text_size: self.size

                Widget:
                    size_hint_y: None
                    height: dp(10)

        # ---------------- PINNED SAVE BUTTON ----------------
        Button:
            text: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ü–µ–ª—å"
            size_hint_y: None
            height: dp(52)
            background_normal: ""
            background_color: 0.27, 0.62, 0.97, 1
            color: 1, 1, 1, 1
            bold: True
            on_release: root.on_save_goal_button_click()

        # ---------------- BOTTOM NAV (your style) ----------------
        BoxLayout:
            size_hint_y: None
            height: dp(74)
            padding: dp(18), dp(10)
            spacing: dp(18)
            canvas.before:
                Color:
                    rgba: 0.06, 0.06, 0.06, 1
                Rectangle:
                    pos: self.pos
                    size: self.size

            Button:
                id: navDashboard
                text: "‚åÇ\n–ì–ª–∞–≤–Ω–∞—è"
                halign: "center"
                valign: "middle"
                text_size: self.size
                font_size: "12sp"
                background_normal: ""
                background_color: 0,0,0,0
                color: 0.7,0.7,0.7,1
                on_release: root.on_nav_click("home")

            Button:
                id: navTransactions
                text: "‚â°\n–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏"
                halign: "center"
                valign: "middle"
                text_size: self.size
                font_size: "12sp"
                background_normal: ""
                background_color: 0,0,0,0
                color: 0.7,0.7,0.7,1
                on_release: root.on_nav_click("transactions")

            Button:
                id: navCategories
                text: "‚ñ¢\n–ö–∞—Ç–µ–≥–æ—Ä–∏–∏"
                halign: "center"
                valign: "middle"
                text_size: self.size
                font_size: "12sp"
                background_normal: ""
                background_color: 0,0,0,0
                color: 0.7,0.7,0.7,1
                on_release: root.on_nav_click("categories")

            Button:
                id: navAnalytics
                text: "‚óî\n–ê–Ω–∞–ª–∏—Ç–∏–∫–∞"
                halign: "center"
                valign: "middle"
                text_size: self.size
                font_size: "12sp"
                background_normal: ""
                background_color: 0,0,0,0
                color: 0.7,0.7,0.7,1
                on_release: root.on_nav_click("analytics")

            Button:
                text: "–¶–µ–ª–∏"
                halign: "center"
                valign: "middle"
                text_size: self.size
                font_size: "12sp"
                background_normal: ""
                background_color: 0,0,0,0
                color: 0.27, 0.62, 0.97, 1
                on_release: root.on_nav_click("goals")

        # ---------------- FRIEND SEARCH POPUP (KV-managed, no Factory) ----------------
        Popup:
            id: friendSearchPopup
            title: ""
            auto_dismiss: True
            size_hint: 0.92, 0.62
            separator_height: 0

            FriendSearchPopupContent:
                screen: root


<GoalConditionRow@BoxLayout>:
    screen: None
    index: 0
    metricValue: "–ë–∞–ª–∞–Ω—Å"
    operatorValue: ">="
    valueText: ""

    orientation: "vertical"
    padding: dp(12)
    spacing: dp(8)
    size_hint_y: None
    height: dp(92)

    canvas.before:
        Color:
            rgba: 0.14, 0.14, 0.14, 1
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [dp(10),]

    BoxLayout:
        size_hint_y: None
        height: dp(36)
        spacing: dp(8)

        Spinner:
            text: root.metricValue
            values: ["–ë–∞–ª–∞–Ω—Å", "–î–æ—Ö–æ–¥—ã", "–†–∞—Å—Ö–æ–¥—ã", "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π"]
            size_hint_x: 0.55
            background_normal: ""
            background_color: 0.15, 0.15, 0.15, 1
            color: 1, 1, 1, 1
            on_text: root.screen.on_condition_metric_change(root.index, self.text) if root.screen else None

        Spinner:
            text: root.operatorValue
            values: [">", ">=", "<", "<=", "=", "!="]
            size_hint_x: 0.25
            background_normal: ""
            background_color: 0.15, 0.15, 0.15, 1
            color: 1, 1, 1, 1
            on_text: root.screen.on_condition_operator_change(root.index, self.text) if root.screen else None

        Button:
            text: "üóë"
            size_hint_x: 0.20
            background_normal: ""
            background_color: 0.35, 0.15, 0.15, 1
            color: 1, 1, 1, 1
            on_release: root.screen.on_delete_condition_click(root.index) if root.screen else None

    TextInput:
        hint_text: "–°—É–º–º–∞ / –∑–Ω–∞—á–µ–Ω–∏–µ"
        text: root.valueText
        on_text: root.screen.on_condition_value_change(root.index, self.text) if root.screen else None
        multiline: False
        size_hint_y: None
        height: dp(40)
        padding: [dp(12), dp(10)]
        background_normal: ""
        background_active: ""
        background_color: 0.15, 0.15, 0.15, 1
        foreground_color: 1, 1, 1, 1
        hint_text_color: 0.6, 0.6, 0.6, 1
        cursor_color: 1, 1, 1, 1


<GoalParticipantRow@BoxLayout>:
    screen: None
    participantId: 0
    userName: ""

    orientation: "horizontal"
    padding: [dp(12), 0, dp(12), 0]
    spacing: dp(8)
    size_hint_y: None
    height: dp(44)

    canvas.before:
        Color:
            rgba: 0.14, 0.14, 0.14, 1
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [dp(10),]

    Label:
        text: root.userName
        halign: "left"
        valign: "middle"
        text_size: self.size
        color: 1, 1, 1, 1

    Button:
        text: "‚úï"
        size_hint_x: None
        width: dp(44)
        background_normal: ""
        background_color: 0.35, 0.15, 0.15, 1
        color: 1, 1, 1, 1
        on_release: root.screen.on_remove_participant_click(root.participantId) if root.screen else None


<FriendSearchPopupContent@BoxLayout>:
    screen: None
    orientation: "vertical"
    padding: dp(12)
    spacing: dp(10)
    canvas.before:
        Color:
            rgba: 0.10, 0.10, 0.10, 1
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [dp(12),]

    # header
    BoxLayout:
        size_hint_y: None
        height: dp(40)
        spacing: dp(8)

        Label:
            text: "–ü–æ–∏—Å–∫ –¥—Ä—É–∑–µ–π"
            bold: True
            halign: "left"
            valign: "middle"
            text_size: self.size
            color: 1,1,1,1

        Widget:

        Button:
            text: "‚úï"
            size_hint_x: None
            width: dp(44)
            background_normal: ""
            background_color: 0.12,0.12,0.12,1
            color: 1,1,1,1
            on_release:
                if root.screen and "friendSearchPopup" in root.screen.ids:
                    root.screen.ids.friendSearchPopup.dismiss()

    # search
    BoxLayout:
        size_hint_y: None
        height: dp(44)
        spacing: dp(10)

        TextInput:
            hint_text: "–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫..."
            text: root.screen.friendSearchText if root.screen else ""
            on_text: root.screen.friendSearchText = self.text if root.screen else None
            multiline: False
            padding: [dp(12), dp(10)]
            background_normal: ""
            background_active: ""
            background_color: 0.15, 0.15, 0.15, 1
            foreground_color: 1, 1, 1, 1
            hint_text_color: 0.6, 0.6, 0.6, 1
            cursor_color: 1, 1, 1, 1

        Button:
            text: "–ò—Å–∫–∞—Ç—å"
            size_hint_x: None
            width: dp(110)
            background_normal: ""
            background_color: 0.27, 0.62, 0.97, 1
            color: 1, 1, 1, 1
            bold: True
