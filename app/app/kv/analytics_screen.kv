#:import dp kivy.metrics.dp
#:import sp kivy.metrics.sp

<StatCard@BoxLayout>:
    titleText: ""
    valueText: ""
    size_hint_y: None
    height: dp(74)
    padding: dp(14), dp(12)
    orientation: "vertical"
    spacing: dp(4)

    canvas.before:
        Color:
            rgba: 0.12, 0.12, 0.12, 1
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [dp(12), dp(12), dp(12), dp(12)]
        Color:
            rgba: 0.22, 0.22, 0.22, 1
        Line:
            rounded_rectangle: (self.x, self.y, self.width, self.height, dp(12))
            width: 1.0

    Label:
        text: root.titleText
        size_hint_y: None
        height: dp(18)
        color: 0.65,0.65,0.65,1
        font_size: sp(12)
        halign: "left"
        valign: "middle"
        text_size: self.size

    Label:
        text: root.valueText
        size_hint_y: None
        height: dp(26)
        color: 1,1,1,1
        font_size: sp(16)
        bold: True
        halign: "left"
        valign: "middle"
        text_size: self.size


<CategoryStatRow@BoxLayout>:
    titleText: ""
    percentText: ""
    amountText: ""
    dotColor: (0.27, 0.62, 0.97, 1)

    size_hint_y: None
    height: dp(34)
    spacing: dp(10)

    BoxLayout:
        size_hint_x: None
        width: dp(14)
        canvas.before:
            Color:
                rgba: root.dotColor
            Ellipse:
                pos: (self.x + dp(2), self.y + dp(10))
                size: (dp(8), dp(8))

    Label:
        text: root.titleText
        color: 1,1,1,1
        font_size: sp(12.5)
        halign: "left"
        valign: "middle"
        text_size: self.size

    Label:
        text: root.percentText
        size_hint_x: None
        width: dp(70)
        color: 0.75,0.75,0.75,1
        font_size: sp(12)
        halign: "right"
        valign: "middle"
        text_size: self.size

    Label:
        text: root.amountText
        size_hint_x: None
        width: dp(90)
        color: 1,1,1,1
        font_size: sp(12.5)
        bold: True
        halign: "right"
        valign: "middle"
        text_size: self.size


<BarRow@BoxLayout>:
    periodText: ""
    valueText: ""
    ratio: 0.0  # 0..1

    size_hint_y: None
    height: dp(44)
    spacing: dp(10)

    Label:
        text: root.periodText
        size_hint_x: None
        width: dp(44)
        color: 0.75,0.75,0.75,1
        font_size: sp(11.5)
        halign: "center"
        valign: "middle"
        text_size: self.size

    BoxLayout:
        orientation: "vertical"
        spacing: dp(6)

        ProgressBar:
            max: 1
            value: root.ratio
            size_hint_y: None
            height: dp(10)

        Label:
            text: root.valueText
            size_hint_y: None
            height: dp(18)
            color: 1,1,1,1
            font_size: sp(12)
            halign: "left"
            valign: "middle"
            text_size: self.size


<AnalyticsScreen>:
    BoxLayout:
        orientation: "vertical"

        # --- Top bar ---
        BoxLayout:
            size_hint_y: None
            height: dp(64)
            padding: dp(16), dp(10)

            Widget:
                size_hint_x: None
                width: dp(44)

            Label:
                text: "Аналитика"
                color: 1,1,1,1
                font_size: sp(16)
                bold: True
                halign: "center"
                valign: "middle"
                text_size: self.size

            Button:
                text: "⟳"
                size_hint: None, None
                size: dp(44), dp(44)
                background_normal: ""
                background_color: 0,0,0,0
                color: 0.85,0.85,0.85,1
                on_release: root.on_refresh_click()

        Widget:
            size_hint_y: None
            height: dp(1)
            canvas.before:
                Color:
                    rgba: 0.15, 0.15, 0.15, 1
                Rectangle:
                    pos: self.pos
                    size: self.size

        # --- Content ---
        ScrollView:
            do_scroll_x: False

            GridLayout:
                cols: 1
                size_hint_y: None
                height: self.minimum_height
                padding: dp(16), dp(16)
                spacing: dp(14)

                # toggle: расходы/доходы
                BoxLayout:
                    size_hint_y: None
                    height: dp(40)
                    padding: dp(6), dp(6)
                    spacing: dp(6)
                    canvas.before:
                        Color:
                            rgba: 0.12, 0.12, 0.12, 1
                        RoundedRectangle:
                            pos: self.pos
                            size: self.size
                            radius: [dp(12), dp(12), dp(12), dp(12)]

                    Button:
                        text: "Расходы"
                        background_normal: ""
                        background_color: 0,0,0,0
                        color: (0,0,0,1) if root.mode == "expense" else (0.75,0.75,0.75,1)
                        on_release: root.set_mode("expense")
                        canvas.before:
                            Color:
                                rgba: (0.27, 0.62, 0.97, 1) if root.mode == "expense" else (0,0,0,0)
                            RoundedRectangle:
                                pos: self.pos
                                size: self.size
                                radius: [dp(10), dp(10), dp(10), dp(10)]

                    Button:
                        text: "Доходы"
                        background_normal: ""
                        background_color: 0,0,0,0
                        color: (0,0,0,1) if root.mode == "income" else (0.75,0.75,0.75,1)
                        on_release: root.set_mode("income")
                        canvas.before:
                            Color:
                                rgba: (0.27, 0.62, 0.97, 1) if root.mode == "income" else (0,0,0,0)
                            RoundedRectangle:
                                pos: self.pos
                                size: self.size
                                radius: [dp(10), dp(10), dp(10), dp(10)]

                # сводка
                BoxLayout:
                    size_hint_y: None
                    height: dp(74)
                    spacing: dp(12)

                    StatCard:
                        titleText: "Общий баланс"
                        valueText: root.balanceText

                    StatCard:
                        titleText: "Фин. грамотность"
                        valueText: root.literacyText

                # доп показатели (под расход/доход)
                BoxLayout:
                    size_hint_y: None
                    height: dp(74)
                    spacing: dp(12)

                    StatCard:
                        titleText: "Всего операций"
                        valueText: root.totalOpsText

                    StatCard:
                        titleText: "Категорий"
                        valueText: root.categoriesCountText

                # Разбивка
                Label:
                    text: "Разбивка по категориям"
                    size_hint_y: None
                    height: dp(26)
                    color: 1,1,1,1
                    font_size: sp(14)
                    bold: True
                    halign: "left"
                    valign: "middle"
                    text_size: self.size

                # "График-пирог" — заглушка
                BoxLayout:
                    size_hint_y: None
                    height: dp(140)
                    padding: dp(12), dp(12)
                    orientation: "vertical"
                    spacing: dp(8)
                    canvas.before:
                        Color:
                            rgba: 0.12, 0.12, 0.12, 1
                        RoundedRectangle:
                            pos: self.pos
                            size: self.size
                            radius: [dp(12), dp(12), dp(12), dp(12)]
                        Color:
                            rgba: 0.22, 0.22, 0.22, 1
                        Line:
                            rounded_rectangle: (self.x, self.y, self.width, self.height, dp(12))
                            width: 1.0

                    Label:
                        text: "Диаграмма (заглушка)"
                        size_hint_y: None
                        height: dp(24)
                        color: 0.75,0.75,0.75,1
                        font_size: sp(12)
                        halign: "center"
                        valign: "middle"
                        text_size: self.size

                    Label:
                        text: root.pieMetaText
                        size_hint_y: None
                        height: dp(22)
                        color: 1,1,1,1
                        font_size: sp(13)
                        bold: True
                        halign: "center"
                        valign: "middle"
                        text_size: self.size

                    Label:
                        text: "Ниже — список категорий"
                        size_hint_y: None
                        height: dp(18)
                        color: 0.65,0.65,0.65,1
                        font_size: sp(11)
                        halign: "center"
                        valign: "middle"
                        text_size: self.size

                RecycleView:
                    size_hint_y: None
                    height: dp(240)
                    viewclass: "CategoryStatRow"
                    data: root.pieRvData

                    RecycleBoxLayout:
                        default_size: None, dp(34)
                        default_size_hint: 1, None
                        size_hint_y: None
                        height: self.minimum_height
                        spacing: dp(8)
                        orientation: "vertical"

                # Поток денег
                Label:
                    text: "Поток денег по периодам"
                    size_hint_y: None
                    height: dp(26)
                    color: 1,1,1,1
                    font_size: sp(14)
                    bold: True
                    halign: "left"
                    valign: "middle"
                    text_size: self.size

                RecycleView:
                    size_hint_y: None
                    height: dp(220)
                    viewclass: "BarRow"
                    data: root.flowRvData

                    RecycleBoxLayout:
                        default_size: None, dp(44)
                        default_size_hint: 1, None
                        size_hint_y: None
                        height: self.minimum_height
                        spacing: dp(10)
                        orientation: "vertical"

                # Аномальная транзакция
                Label:
                    text: "Аномальная транзакция"
                    size_hint_y: None
                    height: dp(26)
                    color: 1,1,1,1
                    font_size: sp(14)
                    bold: True
                    halign: "left"
                    valign: "middle"
                    text_size: self.size

                BoxLayout:
                    size_hint_y: None
                    height: dp(110)
                    padding: dp(14), dp(12)
                    orientation: "vertical"
                    spacing: dp(6)
                    canvas.before:
                        Color:
                            rgba: 0.12, 0.12, 0.12, 1
                        RoundedRectangle:
                            pos: self.pos
                            size: self.size
                            radius: [dp(12), dp(12), dp(12), dp(12)]
                        Color:
                            rgba: 0.22, 0.22, 0.22, 1
                        Line:
                            rounded_rectangle: (self.x, self.y, self.width, self.height, dp(12))
                            width: 1.0

                    Label:
                        text: root.anomalyTitleText
                        size_hint_y: None
                        height: dp(18)
                        color: 1,1,1,1
                        font_size: sp(13)
                        bold: True
                        halign: "left"
                        valign: "middle"
                        text_size: self.size

                    Label:
                        text: root.anomalyDescText
                        color: 0.75,0.75,0.75,1
                        font_size: sp(11.5)
                        halign: "left"
                        valign: "top"
                        text_size: self.size
                        max_lines: 3

                    Label:
                        text: root.anomalyAmountText
                        size_hint_y: None
                        height: dp(18)
                        color: 1,1,1,1
                        font_size: sp(12.5)
                        bold: True
                        halign: "left"
                        valign: "middle"
                        text_size: self.size

                # Цена привычек
                Label:
                    text: "Цена привычек"
                    size_hint_y: None
                    height: dp(26)
                    color: 1,1,1,1
                    font_size: sp(14)
                    bold: True
                    halign: "left"
                    valign: "middle"
                    text_size: self.size

                BoxLayout:
                    size_hint_y: None
                    height: dp(74)
                    padding: dp(14), dp(12)
                    orientation: "vertical"
                    spacing: dp(4)
                    canvas.before:
                        Color:
                            rgba: 0.12, 0.12, 0.12, 1
                        RoundedRectangle:
                            pos: self.pos
                            size: self.size
                            radius: [dp(12), dp(12), dp(12), dp(12)]
                        Color:
                            rgba: 0.22, 0.22, 0.22, 1
                        Line:
                            rounded_rectangle: (self.x, self.y, self.width, self.height, dp(12))
                            width: 1.0

                    Label:
                        text: root.habitCostText
                        color: 1,1,1,1
                        font_size: sp(13)
                        bold: True
                        halign: "left"
                        valign: "middle"
                        text_size: self.size

                    Label:
                        text: "Заглушка: позже будет несколько привычек/категорий"
                        color: 0.65,0.65,0.65,1
                        font_size: sp(11)
                        halign: "left"
                        valign: "middle"
                        text_size: self.size

                # Финансовый профиль
                Label:
                    text: "Финансовый профиль"
                    size_hint_y: None
                    height: dp(26)
                    color: 1,1,1,1
                    font_size: sp(14)
                    bold: True
                    halign: "left"
                    valign: "middle"
                    text_size: self.size

                BoxLayout:
                    size_hint_y: None
                    height: dp(170)
                    padding: dp(14), dp(12)
                    orientation: "vertical"
                    spacing: dp(6)
                    canvas.before:
                        Color:
                            rgba: 0.12, 0.12, 0.12, 1
                        RoundedRectangle:
                            pos: self.pos
                            size: self.size
                            radius: [dp(12), dp(12), dp(12), dp(12)]
                        Color:
                            rgba: 0.22, 0.22, 0.22, 1
                        Line:
                            rounded_rectangle: (self.x, self.y, self.width, self.height, dp(12))
                            width: 1.0

                    Label:
                        text: root.profileSummaryText
                        color: 1,1,1,1
                        font_size: sp(12.5)
                        bold: True
                        halign: "left"
                        valign: "top"
                        text_size: self.size
                        max_lines: 3

                    Label:
                        text: root.profileMetaText
                        color: 0.75,0.75,0.75,1
                        font_size: sp(11.5)
                        halign: "left"
                        valign: "middle"
                        text_size: self.size

                    Label:
                        text: root.profileRecsText
                        color: 0.65,0.65,0.65,1
                        font_size: sp(11.2)
                        halign: "left"
                        valign: "top"
                        text_size: self.size
                        max_lines: 4

                # Прогнозы
                Label:
                    text: "Прогноз на следующий месяц"
                    size_hint_y: None
                    height: dp(26)
                    color: 1,1,1,1
                    font_size: sp(14)
                    bold: True
                    halign: "left"
                    valign: "middle"
                    text_size: self.size

                BoxLayout:
                    size_hint_y: None
                    height: dp(84)
                    padding: dp(14), dp(12)
                    orientation: "vertical"
                    spacing: dp(6)
                    canvas.before:
                        Color:
                            rgba: 0.12, 0.12, 0.12, 1
                        RoundedRectangle:
                            pos: self.pos
                            size: self.size
                            radius: [dp(12), dp(12), dp(12), dp(12)]
                        Color:
                            rgba: 0.22, 0.22, 0.22, 1
                        Line:
                            rounded_rectangle: (self.x, self.y, self.width, self.height, dp(12))
                            width: 1.0

                    Label:
                        text: root.forecastAmountText
                        color: 1,1,1,1
                        font_size: sp(14)
                        bold: True
                        halign: "left"
                        valign: "middle"
                        text_size: self.size

                    Label:
                        text: root.forecastMetaText
                        color: 0.65,0.65,0.65,1
                        font_size: sp(11.2)
                        halign: "left"
                        valign: "middle"
                        text_size: self.size

                Widget:
                    size_hint_y: None
                    height: dp(10)














                # Прогноз по категориям
                Label:
                    text: "Прогноз по категориям"
                    size_hint_y: None
                    height: dp(26)
                    color: 1,1,1,1
                    font_size: sp(14)
                    bold: True
                    halign: "left"
                    valign: "middle"
                    text_size: self.size

                RecycleView:
                    size_hint_y: None
                    height: dp(220)
                    viewclass: "CategoryStatRow"
                    data: root.forecastCatRvData

                    RecycleBoxLayout:
                        default_size: None, dp(34)
                        default_size_hint: 1, None
                        size_hint_y: None
                        height: self.minimum_height
                        spacing: dp(8)
                        orientation: "vertical"

                Label:
                    text: root.forecastCatMetaText
                    size_hint_y: None
                    height: dp(36) if self.text else 0
                    color: 0.65,0.65,0.65,1
                    font_size: sp(11.2)
                    halign: "left"
                    valign: "top"
                    text_size: self.size























        # --- Bottom nav ---
        Widget:
            size_hint_y: None
            height: dp(1)
            canvas.before:
                Color:
                    rgba: 0.15, 0.15, 0.15, 1
                Rectangle:
                    pos: self.pos
                    size: self.size

        BoxLayout:
            size_hint_y: None
            height: dp(74)
            padding: dp(18), dp(10)
            spacing: dp(18)
            canvas.before:
                Color:
                    rgba: 0.06, 0.06, 0.06, 1
                Rectangle:
                    pos: self.pos
                    size: self.size

            Button:
                id: navHome
                text: "⌂\nГлавная"
                halign: "center"
                valign: "middle"
                text_size: self.size
                font_size: sp(12)
                background_normal: ""
                background_color: 0,0,0,0
                color: 0.7,0.7,0.7,1
                on_release: root.on_nav_click("home")

            Button:
                id: navTransactions
                text: "≡\nТранзакции"
                halign: "center"
                valign: "middle"
                text_size: self.size
                font_size: sp(12)
                background_normal: ""
                background_color: 0,0,0,0
                color: 0.7,0.7,0.7,1
                on_release: root.on_nav_click("transactions")

            Button:
                id: navCategories
                text: "▢\nКатегории"
                halign: "center"
                valign: "middle"
                text_size: self.size
                font_size: sp(12)
                background_normal: ""
                background_color: 0,0,0,0
                color: 0.7,0.7,0.7,1
                on_release: root.on_nav_click("categories")

            Button:
                id: navAnalytics
                text: "◔\nАналитика"
                halign: "center"
                valign: "middle"
                text_size: self.size
                font_size: sp(12)
                background_normal: ""
                background_color: 0,0,0,0
                color: 0.27, 0.62, 0.97, 1
                on_release: root.on_nav_click("analytics")
